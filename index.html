<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Climate Data Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    @media (prefers-color-scheme: dark) {
      body { background: #181a1b; color: #fff; }
      .card, .form-control, .form-select { background-color: #222; color: #fff; }
    }
  </style>
</head>
<body>
<div class="container my-4">
  <h1 class="mb-4">Climate Data Dashboard</h1>

  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4">
        <label for="locationSelect" class="form-label">Location</label>
        <select id="locationSelect" class="form-select">
          <option value="Gander_daily_data.csv">Gander</option>
          <!-- Add more locations/files as needed -->
        </select>
      </div>
      <div class="col-md-4">
        <label for="analysisType" class="form-label">Analysis Type</label>
        <select id="analysisType" class="form-select">
          <option value="max">Max Temperature (Year)</option>
          <option value="count-above">Count Temp ≥ X (Year)</option>
          <!-- Add more analysis options -->
        </select>
      </div>
      <div class="col-md-2">
        <label for="yearInput" class="form-label">Year</label>
        <input id="yearInput" type="number" class="form-control" placeholder="e.g. 2023">
      </div>
      <div class="col-md-2 d-none" id="thresholdDiv">
        <label for="thresholdInput" class="form-label">Threshold</label>
        <input id="thresholdInput" type="number" class="form-control" placeholder="e.g. 30">
      </div>
    </div>
    <button id="analyzeBtn" class="btn btn-primary mt-3">Analyze</button>
    <span id="status" class="ms-3"></span>
  </div>

  <div id="resultArea" class="mb-3"></div>
  <div>
    <canvas id="resultChart"></canvas>
  </div>
</div>

<script>
let climateData = [];
let chart = null;

const locationSelect = document.getElementById('locationSelect');
const analysisType = document.getElementById('analysisType');
const yearInput = document.getElementById('yearInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const status = document.getElementById('status');
const resultArea = document.getElementById('resultArea');
const thresholdDiv = document.getElementById('thresholdDiv');
const thresholdInput = document.getElementById('thresholdInput');
const resultChart = document.getElementById('resultChart');

// Show/hide threshold input
analysisType.addEventListener('change', function() {
  thresholdDiv.classList.toggle('d-none', analysisType.value !== 'count-above');
});

function fetchData(filename, callback) {
  status.textContent = "Loading...";
  Papa.parse(filename, {
    header: true,
    download: true,
    skipEmptyLines: true,
    complete: function(results) {
      climateData = results.data;
      status.textContent = "Loaded " + climateData.length + " rows";
      if (callback) callback();
    },
    error: function(err) {
      status.textContent = "Error loading file: " + err;
      climateData = [];
    }
  });
}

function getYearFilterData(year) {
  // Return rows matching year (as "YYYY")
  return climateData.filter(row => {
    // Accept "YYYY-MM-DD" formats in Date/Time
    return row["Date/Time"] && row["Date/Time"].toString().startsWith(year);
  });
}

function showResult(text) {
  resultArea.innerHTML = '<div class="alert alert-info">' + text + '</div>';
}

// --- Analysis Template Functions ---

// Max Temperature in Year
function analyzeMaxTemp(year) {
  let filtered = getYearFilterData(year);
  let maxRow = null, maxVal = null;
  filtered.forEach(row => {
    let v = parseFloat(row["Max Temp (°C)"]);
    if (!isNaN(v) && (maxVal === null || v > maxVal)) {
      maxVal = v; maxRow = row;
    }
  });
  if (maxRow) {
    showResult(`Max Temp: <b>${maxVal}°C</b><br>Date: <b>${maxRow["Date/Time"]}</b>`);
    drawChart(filtered.map(r => r["Date/Time"]), filtered.map(r => parseFloat(r["Max Temp (°C)"])));
  } else {
    showResult("No data for that year.");
    clearChart();
  }
}

// Count of Days Temp ≥ X in Year
function analyzeCountAbove(year, threshold) {
  let filtered = getYearFilterData(year);
  let count = 0;
  filtered.forEach(row => {
    let v = parseFloat(row["Max Temp (°C)"]);
    if (!isNaN(v) && v >= threshold) count++;
  });
  showResult(`Days with Max Temp ≥ <b>${threshold}°C</b> in ${year}: <b>${count}</b>`);
  drawChart(filtered.map(r => r["Date/Time"]), filtered.map(r => parseFloat(r["Max Temp (°C)"])));
}

// --- Chart display ---
function drawChart(labels, values) {
  if (chart) chart.destroy();
  chart = new Chart(resultChart, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Max Temp (°C)',
        data: values,
        borderColor: '#007bff',
        backgroundColor: 'rgba(0,123,255,0.1)',
        fill: true,
        pointRadius: 1,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          title: { display: true, text: 'Date' }, ticks: { maxTicksLimit: 20 }
        },
        y: {
          title: { display: true, text: 'Max Temp (°C)' }
        }
      }
    }
  });
}
function clearChart() {
  if (chart) chart.destroy();
}

// --- Handle analysis ---
analyzeBtn.addEventListener('click', function() {
  if (climateData.length === 0) {
    showResult("Please choose a location."); return;
  }
  const year = yearInput.value;
  if (!year) { showResult("Please enter a year."); clearChart(); return; }
  if (analysisType.value === 'max') {
    analyzeMaxTemp(year);
  } 
  else if (analysisType.value === 'count-above') {
    const threshold = parseFloat(thresholdInput.value);
    if (isNaN(threshold)) { showResult("Please enter a threshold."); clearChart(); return; }
    analyzeCountAbove(year, threshold);
  } 
  // --- Add more analyses here ---
});

// Auto-load first location on page load
window.onload = ()=>{ fetchData(locationSelect.value); }
locationSelect.addEventListener('change', ()=>{ fetchData(locationSelect.value); });

</script>
</body>
</html>
